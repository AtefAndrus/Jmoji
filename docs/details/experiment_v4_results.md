# 実験記録: v4データセットでの学習実験

## 概要

本ドキュメントは、v4データセット（20,000件、Qwen3-235B-A22B生成）での学習実験の結果を記録する。

**実験期間**: 2025-12-23 〜 2025-12-24
**実験環境**: Google Colab Pro（NVIDIA A100-SXM4-40GB）
**目標**: Jaccard 0.10以上、多様性 30%以上

---

## 実験結果サマリー

| # | 実験名 | データ件数 | 件/絵文字 | Jaccard | 多様性 | 状態 |
|---|--------|-----------|-----------|---------|--------|------|
| 1 | v4_lr1e-4 | 20,000 | 15 | 0.066 | 19% | 完了 |
| 2 | v4_top100 | 4,237 | 42 | **0.120** | **21%** | 完了 |

**最良結果**: v4_top100（Jaccard 0.120、目標達成）

---

## 各実験の詳細

### Exp1: v4_lr1e-4（全件使用）

**目的**: v4データセット全件での学習効果を確認

| 設定 | 値 |
|------|-----|
| learning_rate | 1e-4 |
| データ | 20,000件（全件使用） |
| 絵文字種類 | 1,300種 |
| 件/絵文字 | 約15件 |

#### 結果

| 指標 | v3_top100 | v4_lr1e-4 | 変化 |
|------|-----------|-----------|------|
| Avg Jaccard | 0.058 | 0.066 | +14% |
| Micro F1 | 0.094 | 0.112 | +19% |
| 多様性 | 20% | 19% | -5% |
| ユニーク絵文字 | - | 45 | - |

#### 考察

- データ量4倍でJaccard +14%改善
- ただし絵文字種類が1,300種と多く、件/絵文字が15件と低密度
- v3_top100（22件/絵文字）より低密度だが、データ量の効果で上回った

---

### Exp2: v4_top100（Top-100絵文字制限）

**目的**: データ密度を高めて学習効率を向上

| 設定 | 値 |
|------|-----|
| learning_rate | 3e-4（デフォルト） |
| データ | 4,237件（Top-100絵文字のみ） |
| 絵文字種類 | 100種 |
| 件/絵文字 | 約42件 |

#### 結果

| 指標 | v3_top100 | v4_top100 | 変化 |
|------|-----------|-----------|------|
| Avg Jaccard | 0.058 | **0.120** | **+106%** |
| Micro F1 | 0.094 | **0.194** | **+106%** |
| Avg Precision | - | 0.223 | - |
| Avg Recall | - | 0.176 | - |
| 多様性 | 20% | 21% | +5% |
| ユニーク絵文字 | - | 34 | - |
| Eval Loss | 4.714 | 4.660 | -1% |

#### 考察

- **Jaccard 0.12達成**（目標0.10を超過）
- データ密度2倍（22件→42件）でJaccardも2倍以上改善
- **データ密度仮説の強力な実証**
- 多様性は21%で横ばい（目標30%には未達）

---

## 予測サンプル分析

### 良好な例

| 入力 | 正解 | 予測 | Jaccard |
|------|------|------|---------|
| 帰国子女や留学生のための選抜... | 📚🌍🇯🇵😊🎓 | 📚📚🎵😊😊 | 0.33 |
| 日本語の地図だと... | 🗺️📍😊🇯🇵🔍 | 🏛️📚🇯🇵😊😊 | 0.29 |
| 試合、めっちゃ策こらしてた... | ⚽🔥💪😊👏 | 😊👏🤔😊🎉 | 0.29 |

### 課題のある例

| 入力 | 正解 | 予測 | 問題点 |
|------|------|------|--------|
| その頭脳、本人曰く... | 🧠💡😲🤓👏 | 😊😊😊🇯🇵🤝 | 😊の過剰生成 |
| インダクタンスの値や... | 🔧⚙️📡🧠💡 | 🎵😊🇯🇵🤝😊 | 技術文脈の理解不足 |

### 傾向

- 😊、🇯🇵 が頻出（soft mode collapse傾向継続）
- 出力ユニーク絵文字は34種（100種中）
- Exact Match 0%（完全一致なし）

---

## 総合分析

### 実験結果の全体像（v3〜v4）

| 実験 | データ件数 | 件/絵文字 | Jaccard | 多様性 |
|------|-----------|-----------|---------|--------|
| v3_baseline | 5,000 | 6 | 0.045 | ~0% |
| v3_top100 | 2,187 | 22 | 0.058 | 20% |
| v4_lr1e-4 | 20,000 | 15 | 0.066 | 19% |
| **v4_top100** | 4,237 | **42** | **0.120** | **21%** |

### 主要な知見

1. **データ密度の重要性を再確認**
   - 件/絵文字が2倍（22→42）でJaccardも2倍以上改善
   - 絶対データ量より密度が性能を決定

2. **top100フィルタ率の低下**
   - v3: 5,000件中2,187件（43.7%）
   - v4: 20,000件中4,237件（21.2%）
   - Qwen3がより多様な絵文字を生成する傾向

3. **多様性改善は限定的**
   - 20%前後で安定（目標30%には未達）
   - Focal Lossによる改善が必要

### 残課題

| 課題 | 詳細 | 対策案 |
|------|------|--------|
| 多様性不足 | 21%（目標30%） | Focal Loss適用 |
| soft mode collapse | 😊🇯🇵の過剰生成 | 低頻度絵文字の重み付け |
| Exact Match 0% | 完全一致なし | データ密度のさらなる向上 |
| top100フィルタ率低下 | 21.2%（想定44%） | データ生成時のtop100優先 |

---

## 次のステップ

### 短期（推奨）

| アクション | 理由 | 期待効果 |
|-----------|------|----------|
| v4_focal_top100 | 低頻度絵文字の学習促進 | 多様性30%+ |
| top50での検証 | 件/絵文字 84件に向上 | Jaccard 0.15+ |

### 中期

| アクション | 理由 | 期待効果 |
|-----------|------|----------|
| 人手評価の実施 | Jaccard以外の品質確認 | 定性評価 |
| データ生成時のtop100優先 | フィルタ率向上 | より多くの学習データ |

---

## 実験ログの保存場所

```
outputs/experiments/
├── v4_lr1e-4_20251223/
│   ├── config.yaml
│   ├── train_log.csv
│   ├── eval_metrics.json
│   ├── predictions_sample.jsonl
│   └── summary.md
└── v4_top100_20251224/
    ├── config.yaml
    ├── train_log.csv
    ├── eval_metrics.json
    ├── predictions_sample.jsonl
    └── summary.md
```

---

## 関連ドキュメント

- [experiment_v3_improvements.md](experiment_v3_improvements.md): v3での学習改善実験
- [teacher_model_migration.md](teacher_model_migration.md): 教師モデル移行（Qwen3への変更）
- [dataset_generation_v3.md](dataset_generation_v3.md): データセット生成の品質改善
