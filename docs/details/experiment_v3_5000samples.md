# 実験記録: データセットv3（5,000件）での学習結果

## 概要

本ドキュメントは、品質改善版データセット（dataset_v3.jsonl、5,000件）を用いたT5モデル学習の実験結果を記録する。

**結論**: v1で発生した単一絵文字へのmode collapseは緩和されたが、頻出絵文字Top5への「soft mode collapse」が依然として発生。データセット品質の改善だけでは不十分であり、モデル/学習側の追加対策が必要。

---

## 1. データセット統計

### v1 → v3 の改善点

| 項目 | v1 | v3 | 改善 |
|------|-----|-----|------|
| サンプル数 | 1,000 | 5,000 | 5倍 |
| ユニーク絵文字 | 296 | 785 | 2.7倍 |
| 最頻出絵文字 | ✨ 18.6% | 🎵 3.72% | 偏り大幅改善 |
| 半端な文 | 未計測 | 0% | 事前フィルタ適用 |
| SNS内絵文字 | 未計測 | 0% | 絵文字除去適用 |

### v3 絵文字頻度分布（Top 10）

| 順位 | 絵文字 | 出現数 | 割合 |
|------|--------|--------|------|
| 1 | 🎵 | 511 | 3.72% |
| 2 | 📚 | 482 | 3.51% |
| 3 | 🎉 | 343 | 2.50% |
| 4 | 🎤 | 329 | 2.39% |
| 5 | 🏆 | 321 | 2.34% |
| 6 | 😅 | 293 | 2.13% |
| 7 | 😊 | 284 | 2.07% |
| 8 | ⚽ | 248 | 1.80% |
| 9 | 🏛️ | 216 | 1.57% |
| 10 | 🤔 | 188 | 1.37% |

**✨（キラキラ）**: 28件（0.20%）— v1の18.6%から大幅に改善

---

## 2. 学習実験

### 実験環境

- **GPU**: Google Colab Pro（NVIDIA L4 24GB）
  - A100は空きがなく割り当てられず
- **モデル**: sonoisa/t5-base-japanese（222Mパラメータ）
- **追加トークン**: 絵文字トークン（vocab拡張）
- **データ分割**: Train 4,000 / Val 500 / Test 500

### 学習設定

| パラメータ | 値 | 備考 |
|------------|-----|------|
| num_epochs | 50 | default.yamlは10 |
| batch_size | 16 | - |
| learning_rate | 3e-4 | - |
| warmup_steps | 150 | - |
| fp16 | False | NaN防止のため無効化 |
| label_smoothing | 0.1 | mode collapse対策 |
| early_stopping_patience | 5 | - |
| max_input_length | 128 | - |
| max_output_length | 32 | - |

### 学習曲線

| Epoch | Training Loss | Validation Loss |
|-------|---------------|-----------------|
| 1 | 8.387 | 8.317 |
| 2 | 8.277 | 8.235 |
| 3 | 8.150 | 8.091 |
| 4 | 7.728 | 7.553 |
| 5 | 6.778 | 6.316 |
| 6 | 5.983 | 5.834 |
| 7 | 5.762 | 5.656 |
| 8 | 5.610 | 5.667 |
| 9 | 5.468 | 5.576 |
| 10 | 5.498 | 5.592 |
| 11 | 5.351 | **5.531** |
| 12 | 5.395 | 5.681 |
| 13 | 5.338 | 5.624 |
| 14 | 5.292 | 5.567 |
| 15 | 5.273 | 5.639 |
| 16 | 5.212 | 5.624 |

- **最良モデル**: Epoch 11（eval_loss: 5.531）
- **Early Stopping**: Epoch 16で発動（patience=5）
- **過学習の兆候**: Training Lossは継続的に減少するが、Validation Lossは7エポック目以降横ばい

---

## 3. 評価結果

### 定量評価（テストセット 500件）

| 指標 | 値 | 評価 |
|------|-----|------|
| Average Jaccard | 0.0449 | 非常に低い |
| Exact Match Rate | 0.0000 | 完全一致なし |
| Micro F1 | 0.0766 | ほぼランダム |
| Avg Precision | 0.0832 | - |
| Avg Recall | 0.0663 | - |
| Avg F1 | 0.0718 | - |

### 推論テスト（学習データ）

```text
[NG] 入力: 金田が言ってたんだけど、相方の川島の方がビビリらしくて...
     期待: 😂 🪳
     出力: 📚 🎵

[NG] 入力: 勇敢な奴ら1000人ピックアップして、こっそり裏道通して...
     期待: ⚔️ 🚣 🎯
     出力: 📚 ⚽ 🎵

[NG] 入力: ギニアにある海岸線を持つ州って3つしかないんだけど...
     期待: 🌊 🗺️ 🇬🇳
     出力: 📚 📚 🎉
```

### Beam Search vs Sampling 比較

```text
入力: 金田が言ってたんだけど...
  期待: 😂 🪳
  Beam: 🎵 🎵
  Sample: 🎤 🎤

入力: 勇敢な奴ら1000人ピックアップして...
  期待: ⚔️ 🚣 🎯
  Beam: 🎵 🎵 🎵
  Sample: 🎤 🎵 🏛️
```

### 新規テキストでのテスト

```text
入力: 今日は楽しかった → 🎵 🎤
入力: 明日は雨らしい → 📚 🎵
入力: おなかすいた → 🎵 🏆
入力: 試験に合格した → 🎵 📚
入力: 推しが尊い → 📚 😅
入力: めっちゃ眠い → 📚 🎤
```

---

## 4. 分析

### Soft Mode Collapse

v1では✨のみに完全collapseしたが、v3では頻出Top5絵文字（🎵、📚、🎤、🎉、🏆）に分散してcollapseする「soft mode collapse」が発生。

| 比較項目 | v1 | v3 |
|----------|-----|-----|
| Collapse対象 | ✨のみ | Top5絵文字 |
| Jaccard | 0.177 | 0.045 |
| 多様性 | なし | 若干あり |

**Jaccardがv1より低下した理由**: v1では✨が正解に含まれるケースが多かった（18.6%）ため、✨を出力すれば偶然当たることがあった。v3では正解分布が分散したため、頻出絵文字への偏りがより明確に「外れ」となった。

### 原因の考察

1. **データ量 vs 絵文字種類の不均衡**
   - 785種類の絵文字を4,000件で学習
   - 1絵文字あたり平均5件しかない

2. **クロスエントロピー損失の限界**
   - 頻出クラスに偏りやすい（クラス不均衡問題）
   - label_smoothing=0.1では不十分

3. **学習の収束不足**
   - Validation Loss 5.5はまだ高い
   - モデルが「安全な」頻出絵文字に逃げている状態

---

## 5. v1との比較まとめ

| 項目 | v1 (1,000件) | v3 (5,000件) | 評価 |
|------|--------------|--------------|------|
| 最頻出絵文字偏り | 18.6% | 3.72% | 改善 |
| Mode Collapse | 完全（✨のみ） | 部分的（Top5） | やや改善 |
| Jaccard | 0.177 | 0.045 | 悪化（注） |
| Exact Match | 0% | 0% | 変化なし |
| データ品質 | 未検証 | 品質チェック済み | 改善 |

（注）Jaccardの悪化は、正解分布の分散により「まぐれ当たり」が減少したため。

---

## 6. 次のステップ

### 短期（モデル/学習側の対策）

| 対策 | 理由 | 優先度 |
|------|------|--------|
| 学習率を下げる（3e-4 → 1e-4） | 収束が不安定な可能性 | 高 |
| 絵文字をTop-100に制限 | 785種類は多すぎる | 高 |
| Focal Loss導入 | 頻出クラスへの偏りを抑制 | 中 |
| 勾配クリッピング追加 | fp16有効化のため | 中 |

### 中期（データ側の対策）

| 対策 | 理由 | 優先度 |
|------|------|--------|
| データ拡張（10k件以上） | 絵文字あたりのサンプル数を増やす | 高 |
| mC4コーパス追加 | データ多様性の向上 | 中 |
| 絵文字ダウンサンプリング | 頻出絵文字の出現を制限 | 低 |

---

## 7. 実験メタ情報

| 項目 | 値 |
|------|-----|
| 実験日 | 2025-12-05 |
| 実験者 | - |
| 学習時間 | 約30分（L4 GPU） |
| ノートブック | notebooks/train_t5_colab.py |
| データセット | data/outputs/dataset_v3.jsonl |

---

## 関連ドキュメント

- [experiment_v1_1000samples.md](experiment_v1_1000samples.md): v1での実験（mode collapse発生）
- [dataset_generation_v3.md](dataset_generation_v3.md): v3データセットの品質改善
- [研究概要](../research_overview.md): プロジェクト全体の概要
