# ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”Ÿæˆ v3: å“è³ªæ”¹å–„ã¨ä»¶æ•°ä¿è¨¼

## æ¦‚è¦

dataset_v2ï¼ˆ5,000ä»¶ï¼‰ã®å“è³ªåˆ†æã‹ã‚‰å¾—ã‚‰ã‚ŒãŸçŸ¥è¦‹ã‚’åŸºã«ã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ”¹å–„ã—ãŸã€‚ä¸»ãªå¤‰æ›´ç‚¹ã¯ä»¥ä¸‹ã®3ã¤:

1. **äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿**: åŠç«¯ãªæ–‡ã‚’Claudeã«æ¸¡ã™å‰ã«é™¤å¤–
2. **SNSçµµæ–‡å­—é™¤å»**: Claudeå‡ºåŠ›ã‹ã‚‰çµµæ–‡å­—ã‚’é™¤å»
3. **ä»¶æ•°ä¿è¨¼**: ç›®æ¨™ã‚µãƒ³ãƒ—ãƒ«æ•°ã«é”ã™ã‚‹ã¾ã§ç”Ÿæˆã‚’ç¶™ç¶š

---

## 1. dataset_v2ã®å“è³ªåˆ†æ

### åŸºæœ¬çµ±è¨ˆ

| é …ç›® | å€¤ |
|------|-----|
| ç·ã‚µãƒ³ãƒ—ãƒ«æ•° | 4,988ä»¶ |
| ç›®æ¨™ã¨ã®å·® | -12ä»¶ï¼ˆ0.24%ï¼‰ |
| çµµæ–‡å­—ç·æ•° | 13,599 |
| ãƒ¦ãƒ‹ãƒ¼ã‚¯çµµæ–‡å­— | 767ç¨®é¡ |

### çµµæ–‡å­—åˆ†å¸ƒã®æ”¹å–„

v1ã§ã®å•é¡Œã ã£ãŸâœ¨ï¼ˆã‚­ãƒ©ã‚­ãƒ©ï¼‰ã®åã‚Šï¼ˆ18.6%ï¼‰ã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„ã«ã‚ˆã‚Šè§£æ¶ˆã•ã‚ŒãŸã€‚

| é †ä½ | v1 | v2 |
|------|-----|-----|
| 1ä½ | âœ¨ 18.6% | ğŸ“š 3.6% |
| 2ä½ | ğŸ“š 4.1% | ğŸµ 3.2% |
| 3ä½ | ğŸ‰ 3.5% | ğŸ† 2.4% |

### æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ

#### 1. åŠç«¯ãªæ–‡ï¼ˆ271ä»¶ã€5.4%ï¼‰

| ãƒ‘ã‚¿ãƒ¼ãƒ³ | ä»¶æ•° | ä¾‹ |
|----------|------|-----|
| truncated | 118 | `ã€å¤©æ‰ãƒ»ãŸã‘ã—ã®å…ƒæ°—ãŒå‡ºã‚‹ãƒ†ãƒ¬ãƒ“!` |
| meta_section | 70 | `é–¢é€£é …ç›® DJ OZMA LISA è„šæ³¨...` |
| orphan_close | 44 | `ã€ã«å¿œå‹Ÿã—ã€ç•ªçµ„ã®ä¼ç”»ã¨ã—ã¦...` |
| no_ending | 39 | `è¥¿ãƒ‰ã‚¤ãƒ„ã®æ”¿æ²» ãƒ‰ã‚¤ãƒ„ã®è»äº‹å²...` |

**åŸå› **: Wikipediaã®æ–‡åˆ†å‰²ãŒä¸å®Œå…¨ã§ã€è¨˜äº‹ã®æ§‹é€ æƒ…å ±ã‚„é€”ä¸­ã§åˆ‡ã‚ŒãŸæ–‡ãŒæ··å…¥ã€‚

#### 2. SNSå¤‰æ›ã«çµµæ–‡å­—ãŒæ··å…¥ï¼ˆ894ä»¶ã€17.9%ï¼‰

```text
Original: å¤ªé™½ã‚³ãƒ­ãƒŠã¯ã€å¤ªé™½è¡¨é¢ã®æœ‰åŠ¹æ¸©åº¦ã‚ˆã‚Šã‚‚ã¯ã‚‹ã‹ã«é«˜æ¸©ã§ã‚ã‚‹ã€‚
SNS:      å¤ªé™½ã®ã‚³ãƒ­ãƒŠã£ã¦ã€å¤ªé™½ã®è¡¨é¢ã‚ˆã‚Šåœ§å€’çš„ã«ç†±ã„ã‚“ã ã‚ˆã­ã€œğŸŒ ä¸æ€è­°ã ã‚ˆãªã‚
```

Claude HaikuãŒè‡ªç™ºçš„ã«SNSé¢¨ã¨ã—ã¦çµµæ–‡å­—ã‚’æŒ¿å…¥ã—ã¦ã„ãŸã€‚T5ã®å…¥åŠ›ã«çµµæ–‡å­—ãŒæ··ã˜ã‚‹ã¨ã€å‡ºåŠ›ã¨ã®å½¹å‰²ãŒæ›–æ˜§ã«ãªã‚‹å•é¡ŒãŒã‚ã£ãŸã€‚

#### 3. APIå›ç­”ã®æ··å…¥ï¼ˆ1ä»¶ï¼‰

```text
SNS: ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€æä¾›ã„ãŸã ã„ãŸæ–‡ç« ãŒä¸å®Œå…¨ã§ã€æ–‡è„ˆãŒä¸æ˜ç¢ºãªãŸã‚ã€æ­£ç¢ºãªå¤‰æ›ãŒå›°é›£ã§ã™ã€‚
```

å…ƒæ–‡ãŒæ–­ç‰‡çš„ã™ãã¦ClaudeãŒå¤‰æ›ã‚’æ‹’å¦ã—ã€èª¬æ˜æ–‡ã‚’å‡ºåŠ›ã—ãŸã‚±ãƒ¼ã‚¹ã€‚

---

## 2. å®Ÿè£…ã—ãŸæ”¹å–„

### 2.1 äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆtext_preprocessor.pyï¼‰

```python
def is_complete_sentence(text: str) -> tuple[bool, str]:
    """æ–‡ã¨ã—ã¦å®Œå…¨ã‹ã©ã†ã‹ã‚’åˆ¤å®š"""
    # ãƒ¡ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆWikipediaã®æ§‹é€ æƒ…å ±ï¼‰
    if re.match(r'^(é–¢é€£é …ç›®|å‚è€ƒæ–‡çŒ®|å¤–éƒ¨ãƒªãƒ³ã‚¯|è„šæ³¨|å‡ºå…¸|æ³¨é‡ˆ)', text):
        return False, "meta_section"
    # é€”ä¸­åˆ‡ã‚Œï¼ˆé–‹ãæ‹¬å¼§ã§çµ‚ã‚ã‚‹ï¼‰
    if re.search(r'[ï¼ˆ(ã€Œã€][^ï¼‰)ã€ã€]{0,30}$', text):
        return False, "truncated"
    # é–‰ã˜æ‹¬å¼§ã§å§‹ã¾ã‚‹ï¼ˆå‰ã®æ–‡è„ˆãŒãªã„ï¼‰
    if re.match(r'^[ã€ã€ï¼‰)]', text):
        return False, "orphan_close"
    # å¥èª­ç‚¹ãªã—
    if not re.search(r'[ã€‚ï¼ï¼Ÿ!?ã€ã€)]$', text):
        return False, "no_ending"
    return True, ""
```

### 2.2 SNSçµµæ–‡å­—é™¤å»ï¼ˆdataset_generator.pyï¼‰

```python
from src.data.text_preprocessor import remove_emojis

# SNSå¤‰æ›å¾Œã«çµµæ–‡å­—ã‚’é™¤å»
sns_text = client.complete(prompts.SNS_CONVERSION_PROMPT.format(text=sentence)).strip()
sns_text = remove_emojis(sns_text).strip()
```

`emoji.replace_emoji(text, replace="")` ã‚’ä½¿ç”¨ã—ã¦ã€Claudeå‡ºåŠ›ã‹ã‚‰çµµæ–‡å­—ã‚’é™¤å»ã€‚

### 2.3 ä»¶æ•°ä¿è¨¼ï¼ˆwikipedia_loader.py, dataset_generator.pyï¼‰

```yaml
# configs/default.yaml
data:
  max_samples: 5000
  buffer_ratio: 1.3  # 30%å¤šãå–å¾—
```

- Wikipediaå–å¾—æ™‚ã« `max_samples * buffer_ratio` ã®æ–‡ã‚’å–å¾—
- ç”Ÿæˆæ™‚ã«æˆåŠŸä»¶æ•°ãŒ `target_count` ã«é”ã—ãŸã‚‰çµ‚äº†

### 2.4 ãƒ•ã‚£ãƒ«ã‚¿ãƒ­ã‚°

é™¤å¤–ã•ã‚ŒãŸæ–‡ã‚’ `data/outputs/filtered_sentences.jsonl` ã«è¨˜éŒ²:

```json
{"reason": "nsfw", "detail": "æ®ºäºº", "text": "..."}
{"reason": "incomplete", "detail": "meta_section", "text": "é–¢é€£é …ç›® ..."}
{"reason": "incomplete", "detail": "truncated", "text": "ã€å¤©æ‰ãƒ»ãŸã‘ã—ã®..."}
```

---

## 3. çµµæ–‡å­—å¤‰æ›å“è³ªã®è©•ä¾¡

20ä»¶ã®ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒ«ã‚’è©•ä¾¡ã—ãŸçµæœ:

| è©•ä¾¡ | ä»¶æ•° | å‰²åˆ |
|------|------|------|
| ä¸¡æ–¹è‰¯å¥½ | 15 | 75% |
| SNSå¤‰æ›ã«å•é¡Œ | 2 | 10% |
| çµµæ–‡å­—é¸æŠã«å•é¡Œ | 2 | 10% |
| ä¸¡æ–¹å¾®å¦™ | 1 | 5% |

### è‰¯å¥½ãªä¾‹

```text
Original: 1983å¹´ã®ä¸­æ—¥ã‚¯ãƒ©ã‚¦ãƒ³ã‚ºã§ã¯åˆæ—¥6ä½ã‚¿ã‚¤ã§è¿ãˆãŸ2æ—¥ç›®...
SNS:      1983å¹´ã®ä¸­æ—¥ã‚¯ãƒ©ã‚¦ãƒ³ã‚ºã€åˆæ—¥6ä½ã‚¿ã‚¤ã‹ã‚‰2æ—¥ç›®ã«æŒ‘ã‚“ã ã‚“ã ã‘ã©...
Emojis:   â›³ ğŸŒï¸ ğŸ¯ ğŸ˜„
```

### å•é¡Œã®ã‚ã£ãŸä¾‹

```text
Original: ãƒœãƒ­ãƒãƒ•ã¯2018å¹´7æœˆã«ã‚¢ã‚¤ã‚¹ã‚·ãƒ§ãƒ¼å‡ºæ¼”ã®ãŸã‚æ¥æ—¥ã—ãŸéš›ã«...
Emojis:   ğŸ¤ ğŸ©¸ ğŸ˜¢
```

ğŸ©¸ï¼ˆè¡€ï¼‰ãŒæ–‡è„ˆã¨ç„¡é–¢ä¿‚ã€‚ãƒ•ã‚£ã‚®ãƒ¥ã‚¢ã‚¹ã‚±ãƒ¼ãƒˆã®è©±é¡Œãªã®ã«èª¤ã£ãŸçµµæ–‡å­—ãŒé¸æŠã•ã‚ŒãŸã€‚

---

## 4. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´

```yaml
data:
  output_filename: "dataset_v3.jsonl"
  filter_log_filename: "filtered_sentences.jsonl"
  buffer_ratio: 1.3
  complete_sentence_filter: true
```

---

## 5. ã‚³ãƒãƒ³ãƒ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³

```bash
# æ¨™æº–å®Ÿè¡Œï¼ˆå…¨ãƒ•ã‚£ãƒ«ã‚¿æœ‰åŠ¹ï¼‰
uv run scripts/generate_dataset.py --config configs/default.yaml

# éåŒæœŸãƒ¢ãƒ¼ãƒ‰ï¼ˆé«˜é€Ÿï¼‰
uv run scripts/generate_dataset.py --config configs/default.yaml --async

# ãƒ•ã‚£ãƒ«ã‚¿ç„¡åŠ¹åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³
uv run scripts/generate_dataset.py --no-complete-filter  # æ–‡å®Œå…¨æ€§ãƒ•ã‚£ãƒ«ã‚¿ç„¡åŠ¹
uv run scripts/generate_dataset.py --no-nsfw-filter      # NSFWãƒ•ã‚£ãƒ«ã‚¿ç„¡åŠ¹
```

---

## 6. æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„åŠ¹æœ

| é …ç›® | v2 | v3ï¼ˆæœŸå¾…ï¼‰ |
|------|-----|------------|
| åŠç«¯ãªæ–‡ | 271ä»¶ï¼ˆ5.4%ï¼‰ | 0ä»¶ |
| SNSå†…çµµæ–‡å­— | 894ä»¶ï¼ˆ17.9%ï¼‰ | 0ä»¶ |
| APIå›ç­”æ··å…¥ | 1ä»¶ | 0ä»¶ |
| ä»¶æ•°ä¿è¨¼ | 4,988ä»¶ | 5,000ä»¶ |

---

## 7. ä»Šå¾Œã®èª²é¡Œ

1. **çµµæ–‡å­—é¸æŠã®ç²¾åº¦å‘ä¸Š**: ä¸€éƒ¨ã®æ–‡è„ˆã§ç„¡é–¢ä¿‚ãªçµµæ–‡å­—ãŒé¸æŠã•ã‚Œã‚‹å•é¡Œï¼ˆç´„10%ï¼‰
2. **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æ”¹å–„**: ã‚ˆã‚Šå…·ä½“çš„ãªæ–‡è„ˆç†è§£ã‚’ä¿ƒã™ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ
3. **ãƒ‡ãƒ¼ã‚¿æ‹¡å¼µ**: mC4ãªã©ä»–ã®ã‚³ãƒ¼ãƒ‘ã‚¹ã®è¿½åŠ æ¤œè¨
