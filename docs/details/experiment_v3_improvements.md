# 実験記録: v3データセットでの学習改善実験

## 概要

本ドキュメントは、v3データセット（5,000件）でのsoft mode collapse問題に対する学習改善実験の結果を記録する。

**実験期間**: 2025-12-12
**実験環境**: Google Colab Pro（NVIDIA A100-SXM4-40GB）
**ベースライン**: [experiment_v3_5000samples.md](experiment_v3_5000samples.md)（Jaccard 0.045）

---

## 実験計画と結果サマリー

| # | 実験名 | 変更点 | Jaccard | 多様性 | 状態 |
|---|--------|--------|---------|--------|------|
| 0 | v3_baseline | - | 0.0449 | ~0% | 完了（参照） |
| 1 | v3_lr1e-4 | learning_rate: 3e-4→1e-4 | 0.0481 | 10.9% | 完了 |
| 2 | v3_top100 | 絵文字をTop-100に制限 | **0.0581** | **19.8%** | 完了 |
| 3 | v3_lr1e-4_top100 | 1+2の組み合わせ | 0.0000 | - | 完了（失敗） |
| 4 | v3_focal_top100 | Focal Loss + Top-100 | 0.0577 | 17.3% | 完了 |

**最良結果**: v3_top100（Jaccard 0.0581、多様性 19.8%）

---

## 各実験の詳細

### Exp1: v3_lr1e-4（学習率調整）

**仮説**: 学習率が高すぎて頻出クラスに早期収束している

| 設定 | 値 |
|------|-----|
| learning_rate | 1e-4（3e-4から変更） |
| データ | 5,000件（全件使用） |
| 絵文字種類 | 785種 |

#### 結果

| 指標 | baseline | lr1e-4 | 変化 |
|------|----------|--------|------|
| Avg Jaccard | 0.0449 | 0.0481 | +7.1% |
| Exact Match | 0.00% | 0.00% | - |
| Micro F1 | 0.0766 | 0.0805 | +5.1% |
| Non-Top5 Ratio | ~0% | 10.9% | 改善 |
| Eval Loss | 5.531 | 5.648 | +2.1% |

#### 考察

- Jaccardは微増（+7%）だが目標の0.10には程遠い
- 多様性は10.9%に改善（目標30%には未達）
- 50エポック完走（Early Stopping発動せず）
- 学習率調整だけでは不十分

---

### Exp2: v3_top100（Top-100絵文字制限）

**仮説**: 785種類は多すぎる。学習対象を絞ることで各絵文字のサンプル数を増加

| 設定 | 値 |
|------|-----|
| learning_rate | 3e-4（デフォルト） |
| データ | 2,187件（Top-100絵文字のみ含むサンプル） |
| 絵文字種類 | 100種 |
| 1絵文字あたりサンプル | 約22件（元約6件） |

#### 結果

| 指標 | baseline | top100 | 変化 |
|------|----------|--------|------|
| Avg Jaccard | 0.0449 | **0.0581** | **+29.4%** |
| Exact Match | 0.00% | 0.00% | - |
| Micro F1 | 0.0766 | 0.0939 | +22.6% |
| Non-Top5 Ratio | ~0% | **19.8%** | **大幅改善** |
| Eval Loss | 5.531 | 4.714 | -14.8% |

#### 考察

- **これまでで最良の結果**
- データ量は43.7%に減少したが、絵文字密度が3.4倍に向上
- 多様性19.8%は目標30%に近づいた
- epoch 24でbest、Early Stopping発動（過学習抑制）
- **絶対数より「絵文字あたりのサンプル密度」が重要**という知見

---

### Exp3: v3_lr1e-4_top100（組み合わせ）

**仮説**: Exp1とExp2の相乗効果

| 設定 | 値 |
|------|-----|
| learning_rate | 1e-4 |
| データ | 2,187件 |
| 絵文字種類 | 100種 |

#### 結果

| 指標 | top100 | lr1e-4_top100 | 変化 |
|------|--------|---------------|------|
| Avg Jaccard | 0.0581 | **0.0000** | **完全失敗** |
| Eval Loss | 4.714 | 8.086 | +71.5% |

#### 予測サンプル（異常）

```
入力: オリコン最高87位だった！
期待: 🎵 📈 😊
出力: 年国勢調査での人口は年国勢調査での人口は  ← 絵文字ではなくテキスト
```

#### 考察

- **完全失敗**: モデルが絵文字出力を学習できず
- 原因: データ量不足（2,187件）× 低学習率（1e-4）の組み合わせ
- T5の事前学習パターン（日本語テキスト出力）に退行
- **少データ環境では高めの学習率（3e-4）が必須**という知見

---

### Exp4: v3_focal_top100（Focal Loss + Top-100）

**仮説**: Focal Lossで低頻度クラスの学習を促進

| 設定 | 値 |
|------|-----|
| learning_rate | 3e-4 |
| focal_gamma | 2.0 |
| label_smoothing | 0.0（Focal Lossと併用しない） |
| データ | 2,187件 |
| 絵文字種類 | 100種 |

#### 結果

| 指標 | top100 | focal_top100 | 変化 |
|------|--------|--------------|------|
| Avg Jaccard | 0.0581 | 0.0577 | -0.7% |
| Exact Match | 0.00% | **0.46%** | **初達成** |
| Micro F1 | 0.0939 | 0.0930 | -1.0% |
| Non-Top5 Ratio | 19.8% | 17.3% | -12.6% |
| Eval Loss | 4.714 | **3.485** | **-26.1%** |

#### 考察

- Eval Lossは大幅改善（-26%）
- **初のExact Match達成**（0.46%）
- ただしJaccard、多様性はほぼ横ばい〜やや悪化
- Focal Lossは学習の収束を改善するが、予測精度の大幅向上にはつながらず

---

## 総合分析

### 実験結果の全体像

| 実験 | Jaccard | 多様性 | Eval Loss | 評価 |
|------|---------|--------|-----------|------|
| baseline | 0.045 | ~0% | 5.531 | 基準 |
| lr1e-4 | 0.048 | 11% | 5.648 | 微改善 |
| **top100** | **0.058** | **20%** | 4.714 | **最良** |
| lr1e-4_top100 | 0.000 | - | 8.086 | 失敗 |
| focal_top100 | 0.058 | 17% | 3.485 | 横ばい |

### 主要な知見

1. **データ密度が最重要**
   - 絶対数より「絵文字あたりのサンプル数」が性能を決定
   - top100: 6件/絵文字 → 22件/絵文字で+29%改善

2. **少データ環境では学習率を下げすぎない**
   - lr1e-4_top100の失敗が示すように、2,000件規模では3e-4が必要

3. **Focal Lossの効果は限定的**
   - Loss改善・初Exact Matchは達成したが、Jaccard改善には寄与せず

4. **目標未達の原因**
   - 現状22件/絵文字は機械学習タスクとして不十分
   - 目標（Jaccard > 0.10、多様性 > 30%）には50件以上/絵文字が必要と推定

### データ密度シミュレーション

| データ規模 | top100フィルタ後 | 件/絵文字 | 期待効果 |
|-----------|-----------------|-----------|----------|
| 5k（現状） | 2,187 | 22件 | Jaccard 0.058 |
| 10k | ~4,400 | ~44件 | 改善期待 |
| 20k | ~8,800 | ~88件 | 大幅改善期待 |
| 50k | ~22,000 | ~220件 | 目標達成可能? |

---

## 次のステップ

### 短期（推奨）

| アクション | 理由 | 優先度 |
|-----------|------|--------|
| v4データセット生成（10k〜20k件） | 密度2〜4倍で根本解決 | 高 |
| top50での検証 | 現データで密度2倍、即座に検証可能 | 中 |

### 中期

| アクション | 理由 | 優先度 |
|-----------|------|--------|
| 人手評価の実施 | Jaccard以外の品質指標確認 | 中 |
| セマンティック類似度導入 | 評価指標の妥当性検証 | 中 |

### 長期

| アクション | 理由 | 優先度 |
|-----------|------|--------|
| T5-largeの検討 | モデル容量の限界確認 | 低 |
| mC4コーパス追加 | データ多様性向上 | 低 |

---

## 実験ログの保存場所

各実験の詳細ログは `outputs/experiments/` に保存:

```
outputs/experiments/
├── v3_lr1e-4_20251212/
├── v3_top100_20251212/
├── v3_lr1e-4_top100_20251212/
└── v3_focal_top100_20251212/
```

各ディレクトリには以下のファイルを含む:
- `config.yaml`: 実験設定
- `train_log.csv`: 学習ログ
- `eval_metrics.json`: 評価結果
- `predictions_sample.jsonl`: 予測サンプル（20件）
- `summary.md`: 実験サマリー

---

## 関連ドキュメント

- [experiment_v3_5000samples.md](experiment_v3_5000samples.md): v3ベースラインの実験結果
- [experiment_plan_v3_improvements.md](experiment_plan_v3_improvements.md): 本実験の計画書
- [experiment_v1_1000samples.md](experiment_v1_1000samples.md): v1での実験（完全mode collapse）
- [dataset_generation_v3.md](dataset_generation_v3.md): v3データセットの品質改善
