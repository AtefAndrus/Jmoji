# 実験記録: v4データセットでの学習実験

## 概要

本ドキュメントは、v4データセット（20,000件、Qwen3-235B-A22B生成）での学習実験の結果を記録する。

**実験期間**: 2025-12-23 〜 2025-12-24
**実験環境**: Google Colab Pro（NVIDIA A100-SXM4-40GB）
**目標**: Jaccard 0.10以上、多様性 30%以上

---

## 実験結果サマリー

| # | 実験名 | データ件数 | 件/絵文字 | Jaccard | 多様性 | 状態 |
|---|--------|-----------|-----------|---------|--------|------|
| 1 | v4_lr1e-4 | 20,000 | 15 | 0.066 | 19% | 完了 |
| 2 | v4_top100 | 4,237 | 42 | 0.120 | 21% | 完了 |
| 3 | v4_focal_top100 | 4,237 | 42 | 0.115 | **25%** | 完了 |
| 4 | v4_top50 | 1,337 | 27 | 0.165 | 21% | 完了 |
| 5 | v4_focal_top50 | 1,337 | 27 | **0.182** | 14% | 完了 |

**最良結果**: v4_focal_top50（Jaccard 0.182、精度最良）、v4_focal_top100（多様性25%、多様性最良）

---

## 各実験の詳細

### Exp1: v4_lr1e-4（全件使用）

**目的**: v4データセット全件での学習効果を確認

| 設定 | 値 |
|------|-----|
| learning_rate | 1e-4 |
| データ | 20,000件（全件使用） |
| 絵文字種類 | 1,300種 |
| 件/絵文字 | 約15件 |

#### 結果

| 指標 | v3_top100 | v4_lr1e-4 | 変化 |
|------|-----------|-----------|------|
| Avg Jaccard | 0.058 | 0.066 | +14% |
| Micro F1 | 0.094 | 0.112 | +19% |
| 多様性 | 20% | 19% | -5% |
| ユニーク絵文字 | - | 45 | - |

#### 考察

- データ量4倍でJaccard +14%改善
- ただし絵文字種類が1,300種と多く、件/絵文字が15件と低密度
- v3_top100（22件/絵文字）より低密度だが、データ量の効果で上回った

---

### Exp2: v4_top100（Top-100絵文字制限）

**目的**: データ密度を高めて学習効率を向上

| 設定 | 値 |
|------|-----|
| learning_rate | 3e-4（デフォルト） |
| データ | 4,237件（Top-100絵文字のみ） |
| 絵文字種類 | 100種 |
| 件/絵文字 | 約42件 |

#### v4_top100 結果

| 指標 | v3_top100 | v4_top100 | 変化 |
|------|-----------|-----------|------|
| Avg Jaccard | 0.058 | **0.120** | **+106%** |
| Micro F1 | 0.094 | **0.194** | **+106%** |
| Avg Precision | - | 0.223 | - |
| Avg Recall | - | 0.176 | - |
| 多様性 | 20% | 21% | +5% |
| ユニーク絵文字 | - | 34 | - |
| Eval Loss | 4.714 | 4.660 | -1% |

#### v4_top100 考察

- **Jaccard 0.12達成**（目標0.10を超過）
- データ密度2倍（22件→42件）でJaccardも2倍以上改善
- **データ密度仮説の強力な実証**
- 多様性は21%で横ばい（目標30%には未達）

---

### Exp3: v4_focal_top100（Focal Loss + Top-100）

**目的**: Focal Lossで低頻度絵文字の学習を促進し、多様性を改善

| 設定 | 値 |
|------|-----|
| learning_rate | 3e-4（デフォルト） |
| focal_gamma | 2.0 |
| label_smoothing | 0.0（Focal Lossと併用しない） |
| データ | 4,237件（Top-100絵文字のみ） |
| 絵文字種類 | 100種 |
| 件/絵文字 | 約42件 |

#### v4_focal_top100 結果

| 指標 | v4_top100 | v4_focal_top100 | 変化 |
|------|-----------|-----------------|------|
| Avg Jaccard | 0.120 | 0.115 | -3.5% |
| Micro F1 | 0.194 | 0.189 | -2.6% |
| Avg Precision | 0.223 | 0.217 | -2.7% |
| Avg Recall | 0.176 | 0.172 | -2.3% |
| 多様性 | 21% | **25%** | **+19%** |
| ユニーク絵文字 | 34 | 34 | - |
| Eval Loss | 4.660 | **3.450** | **-26%** |

#### v4_focal_top100 考察

- **多様性改善に成功**: 21%→25%（+19%）で目標30%に接近
- **Eval Loss大幅改善**: -26%で学習収束が改善
- **Jaccardは微減**: -3.5%でFocal Lossは精度向上には寄与せず
- Exact Match 0%（v3_focal_top100では0.46%達成）
- 📚、😊、🔥 の過剰生成傾向は継続（soft mode collapse）

---

### Exp4: v4_top50（Top-50絵文字制限）

**目的**: 絵文字種類をさらに制限し、精度向上を検証

| 設定 | 値 |
|------|-----|
| learning_rate | 3e-4（デフォルト） |
| データ | 1,337件（Top-50絵文字のみ） |
| 絵文字種類 | 50種 |
| 件/絵文字 | 約27件 |

注: 期待した84件/絵文字ではなく27件。top50絵文字のみを含むサンプルがv4データセットでは少なかった。

#### v4_top50 結果

| 指標 | v4_top100 | v4_top50 | 変化 |
|------|-----------|----------|------|
| Avg Jaccard | 0.120 | **0.165** | **+38%** |
| Micro F1 | 0.194 | **0.269** | **+38%** |
| Avg Precision | 0.223 | 0.313 | +40% |
| Avg Recall | 0.176 | 0.234 | +33% |
| 多様性 | 21% | 21% | - |
| ユニーク絵文字 | 34 | 16 | -53% |
| Eval Loss | 4.660 | 4.195 | -10% |

#### v4_top50 考察

- **Jaccard 0.165達成**: 目標0.15+を超過、これまでで最高精度
- **絵文字種類削減の効果**: 100→50種で精度+38%向上
- **多様性は改善せず**: 21%で横ばい
- **出力多様性低下**: ユニーク絵文字16種（50種中32%のみ使用）
- 📚、😊、🇯🇵、🎉 が頻出（soft mode collapse継続）

---

### Exp5: v4_focal_top50（Focal Loss + Top-50）

**目的**: top50環境でFocal Lossを適用し、精度と多様性の両立を検証

| 設定 | 値 |
|------|-----|
| learning_rate | 3e-4（デフォルト） |
| focal_gamma | 2.0 |
| label_smoothing | 0.0（Focal Lossと併用しない） |
| データ | 1,337件（Top-50絵文字のみ） |
| 絵文字種類 | 50種 |
| 件/絵文字 | 約27件 |

#### v4_focal_top50 結果

| 指標 | v4_top50 | v4_focal_top50 | 変化 |
|------|----------|----------------|------|
| Avg Jaccard | 0.165 | **0.182** | **+10%** |
| Micro F1 | 0.269 | 0.286 | +6% |
| Avg Precision | 0.313 | 0.345 | +10% |
| Avg Recall | 0.234 | 0.250 | +7% |
| 多様性 | 21% | **14%** | **-33%** |
| ユニーク絵文字 | 16 | 16 | - |
| Eval Loss | 4.195 | **2.949** | **-30%** |

#### v4_focal_top50 考察

- **Jaccard 0.182達成**: これまでの最高記録を更新
- **精度大幅改善**: Precision +10%、Recall +7%
- **多様性が大幅悪化**: 21%→14%（-33%）、予想と逆の結果
- top100環境では多様性改善に寄与したFocal Lossが、top50では逆効果
- **仮説**: 絵文字種類が少ない環境では、Focal Lossが特定絵文字への過学習を促進

---

## 予測サンプル分析

### 良好な例

| 入力 | 正解 | 予測 | Jaccard |
|------|------|------|---------|
| 帰国子女や留学生のための選抜... | 📚🌍🇯🇵😊🎓 | 📚📚🎵😊😊 | 0.33 |
| 日本語の地図だと... | 🗺️📍😊🇯🇵🔍 | 🏛️📚🇯🇵😊😊 | 0.29 |
| 試合、めっちゃ策こらしてた... | ⚽🔥💪😊👏 | 😊👏🤔😊🎉 | 0.29 |

### 課題のある例

| 入力 | 正解 | 予測 | 問題点 |
|------|------|------|--------|
| その頭脳、本人曰く... | 🧠💡😲🤓👏 | 😊😊😊🇯🇵🤝 | 😊の過剰生成 |
| インダクタンスの値や... | 🔧⚙️📡🧠💡 | 🎵😊🇯🇵🤝😊 | 技術文脈の理解不足 |

### 傾向

- 😊、🇯🇵 が頻出（soft mode collapse傾向継続）
- 出力ユニーク絵文字は34種（100種中）
- Exact Match 0%（完全一致なし）

---

## 総合分析

### 実験結果の全体像（v3〜v4）

| 実験 | データ件数 | 件/絵文字 | Jaccard | 多様性 |
|------|-----------|-----------|---------|--------|
| v3_baseline | 5,000 | 6 | 0.045 | ~0% |
| v3_top100 | 2,187 | 22 | 0.058 | 20% |
| v4_lr1e-4 | 20,000 | 15 | 0.066 | 19% |
| v4_top100 | 4,237 | 42 | 0.120 | 21% |
| v4_focal_top100 | 4,237 | 42 | 0.115 | **25%** |
| v4_top50 | 1,337 | 27 | 0.165 | 21% |
| **v4_focal_top50** | 1,337 | 27 | **0.182** | 14% |

### 主要な知見

1. **絵文字種類削減が精度向上に効果的**
   - 100種→50種でJaccard +38%（0.120→0.165）
   - Focal Loss追加でさらに+10%（0.165→0.182）

2. **Focal Lossの効果は環境依存**
   - top100環境: 多様性改善（21%→25%）、精度微減
   - top50環境: 精度改善（+10%）、多様性悪化（21%→14%）
   - 絵文字種類が少ない環境では特定絵文字への過学習を促進

3. **精度と多様性のトレードオフ**
   - 精度重視: v4_focal_top50（Jaccard 0.182、多様性14%）
   - 多様性重視: v4_focal_top100（Jaccard 0.115、多様性25%）
   - バランス型: v4_top50（Jaccard 0.165、多様性21%）

4. **top50フィルタ率の低下**
   - v4_top100: 20,000件中4,237件（21.2%）
   - v4_top50: 20,000件中1,337件（6.7%）
   - Qwen3がより多様な絵文字を生成する傾向

### 残課題

| 課題 | 詳細 | 対策案 |
|------|------|--------|
| 精度と多様性の両立困難 | 最高精度0.182 vs 最高多様性25% | 用途に応じたモデル選択 |
| soft mode collapse | 😊📚🇯🇵🎉の過剰生成 | データ生成時の絵文字分布制御 |
| Exact Match 0% | 完全一致なし | さらなるデータ規模拡大 |
| top50フィルタ率低下 | 6.7%（期待値の1/3） | データ生成時のtop50優先 |

---

## 次のステップ

### 短期（推奨）

| アクション | 理由 | 期待効果 |
|-----------|------|----------|
| 人手評価の実施 | Jaccard以外の品質確認 | 定性評価・ユーザビリティ確認 |
| モデル選択ガイドライン作成 | 用途に応じた推奨モデル明確化 | 実用化への準備 |

### 中期

| アクション | 理由 | 期待効果 |
|-----------|------|----------|
| v5データセット生成（top50優先） | フィルタ率向上（現状6.7%） | より多くの学習データ |
| 絵文字分布制御の導入 | soft mode collapse対策 | 多様性改善 |

---

## 実験ログの保存場所

```text
outputs/experiments/
├── v4_lr1e-4_20251223/
├── v4_top100_20251224/
├── v4_focal_top100_20251224/
├── v4_top50_20251224/
└── v4_focal_top50_20251224/
```

各ディレクトリには以下のファイルを含む:

- `config.yaml`: 実験設定
- `train_log.csv`: 学習ログ
- `eval_metrics.json`: 評価結果
- `predictions_sample.jsonl`: 予測サンプル（20件）
- `summary.md`: 実験サマリー

---

## 関連ドキュメント

- [v3_improvements.md](v3_improvements.md): v3での学習改善実験
- [teacher_model_migration.md](../teacher_model_migration.md): 教師モデル移行（Qwen3への変更）
- [generation_v3.md](../datasets/generation_v3.md): データセット生成の品質改善
