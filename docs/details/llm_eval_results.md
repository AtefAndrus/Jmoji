# LLM-as-a-Judge 評価結果

## 概要

本ドキュメントは、Claude Code subagents（Opus 4.5）を用いた絵文字予測モデルの自動評価結果を記録する。

**実施日**: 2026-01-03
**評価者**: Claude Opus 4.5（subagent経由）
**評価対象**: 20サンプル × 2モデル = 40評価

---

## 評価対象モデル

| モデル | Jaccard | 多様性 | 説明 |
|--------|---------|--------|------|
| v4_focal_top50 | 0.182 | 14% | Focal Loss適用、精度最良 |
| v4_top50 | 0.165 | 21% | 標準学習、バランス型 |

---

## 評価基準

### 定性評価項目

| 項目 | スケール | 説明 |
|------|----------|------|
| semantic_relevance | 0-4 | テキストの意味・感情を絵文字が表現しているか |
| naturalness | 0-4 | 日本のSNSで見かけそうな使い方か |
| misleading | yes/no | 誤解を招く可能性があるか |

### エラーカテゴリ

| カテゴリ | 説明 |
|----------|------|
| overgeneration | 同一絵文字の過剰な繰り返し |
| emotion_mismatch | 感情の誤判定（中立/疑問に対してポジティブ等） |
| context_miss | 文脈理解の不足（核心的な要素を捉えられていない） |
| none | 特に問題なし |

---

## 評価結果

### 総合スコア

| 指標 | v4_focal_top50 | v4_top50 | 優位 |
|------|----------------|----------|------|
| 平均意味的一致度 | 1.55/4.0 | **1.75/4.0** | top50 |
| 平均自然さ | 1.25/4.0 | **1.45/4.0** | top50 |
| 勝利数 | 6 | **9** | top50 |
| 引き分け | 5 | 5 | - |
| Jaccard（定量） | **0.182** | 0.165 | focal_top50 |

### バッチ別結果

| バッチ | focal_top50 wins | top50 wins | ties |
|--------|------------------|------------|------|
| 1-10 | **5** | 2 | 3 |
| 11-20 | 1 | **7** | 2 |
| **合計** | 6 | **9** | 5 |

### エラーカテゴリ分布

| カテゴリ | v4_focal_top50 | v4_top50 |
|----------|----------------|----------|
| overgeneration | 5件 | 5件 |
| emotion_mismatch | **4件** | 2件 |
| context_miss | 5件 | 6件 |
| none | 6件 | 7件 |

---

## 主要な発見

### 1. Jaccardと主観評価の逆転

| モデル | Jaccard（定量） | LLM評価（主観） |
|--------|----------------|-----------------|
| v4_focal_top50 | **0.182（高い）** | 6勝（低い） |
| v4_top50 | 0.165（低い） | **9勝（高い）** |

**原因分析**:

1. **過剰生成パターンの違い**
   - focal_top50: 同一絵文字の連続（😊😊😊😊😊）が多い
   - top50: より多様な絵文字選択

2. **Jaccardの限界**
   - 集合ベースのため、同じ絵文字の連続は1種類としてカウント
   - 「自然さ」「多様性」を評価できない

### 2. Focal Lossの副作用

| 観点 | 効果 |
|------|------|
| Jaccard（精度） | +10%改善 |
| 多様性 | -33%悪化（21%→14%） |
| 自然さ | 悪化（特定絵文字への過学習） |

**結論**: Focal Lossは精度向上に寄与するが、特定絵文字への過学習を促進し、出力の自然さが低下する。

### 3. 両モデル共通の課題

| 課題 | 詳細 |
|------|------|
| 思考系絵文字の欠如 | 🤔🔍💡をほぼ生成できない |
| 建造物系が苦手 | 🏛️🏯🏫がほとんど出ない |
| 感情系への偏り | 😊🎉👏に集中 |
| スポーツ系の欠如 | ⚾を生成できない |

---

## 代表的な評価例

### 良好な例（v4_top50優位）

**Sample 3**: 「港区の大会で上位入賞したりして、結構アピールしたわ〜」

| モデル | 出力 | スコア | 評価 |
|--------|------|--------|------|
| gold | 🏆🎉👏🇯🇵💪 | - | - |
| focal_top50 | 📺😊😊😊😊 | 1 | 📺が文脈と無関係、😊連発 |
| top50 | 🎉🇯🇵🇯🇵😊🇯🇵 | 3 | 🎉が適切、祝福の文脈 |

### 問題のある例（両モデルとも低評価）

**Sample 11**: 「自性分別ってのは、尋と伺のことで、分別の一種ってことね。」

| モデル | 出力 | スコア | 評価 |
|--------|------|--------|------|
| gold | 🤔🧠📖✨🔍 | - | - |
| focal_top50 | 😊😊😊😊😊 | 0 | 完全なmode collapse |
| top50 | 📖😊🎉💼🇯🇵 | 2 | 📖は適切だが🎉は不適切 |

---

## 用途別モデル推奨

| 用途 | 推奨モデル | 理由 |
|------|-----------|------|
| Jaccard最大化（研究評価） | v4_focal_top50 | 定量指標で最高 |
| 自然さ・多様性重視 | v4_top50 | LLM評価で優位 |
| 実用（SNS投稿補助） | v4_top50 | ユーザー体験重視 |

---

## 評価手法について

### LLM-as-a-Judge の利点

| 利点 | 詳細 |
|------|------|
| 速度 | 20件を数分で評価（人手: 30分以上） |
| 一貫性 | 評価基準の適用が安定 |
| スケーラビリティ | 大量サンプル評価可能 |
| 詳細な理由付け | 各評価に日本語の説明 |

### 制限・注意点

| 制限 | 詳細 |
|------|------|
| LLMバイアス | 特定の絵文字選択を好む可能性 |
| 人間との相関 | 未検証（今後の課題） |
| コスト | Opus 4.5は高価 |

---

## 実装詳細

### 使用ツール

```
Task tool + general-purpose subagent + model: opus
```

### 評価フロー

```
1. predictions_sample.jsonl から20件を取得
2. 2バッチ（各10件）に分割
3. 並列でsubagent評価を実行
4. 結果をJSON形式で収集
5. 集計・分析
```

### 評価プロンプト構成

1. 評価基準の定義（0-4スケール）
2. エラーカテゴリの説明
3. サンプルデータ（text, gold, model_a, model_b）
4. 出力形式の指定（JSON）

---

## 今後の課題

| 課題 | 優先度 | 状態 |
|------|--------|------|
| repetition penalty導入 | 高 | **完了** |
| 人手評価との相関検証 | 中 | 未着手 |
| 追加モデル比較 | 低 | 未着手 |

---

## Repetition Penalty 導入結果（2026-01-03追記）

### 概要

LLM評価で発見された過剰生成問題に対し、`repetition_penalty`パラメータを導入してテストを実施。

### テスト結果

#### v4_focal_top50

| penalty | 平均unique率 | 特記事項 |
|---------|-------------|----------|
| 1.0 | 60% (3/5) | 過剰生成多発 |
| **1.2** | **96% (4.8/5)** | **推奨** |
| 1.5 | 100% | 🤔出現あり |

#### v4_top50

| penalty | 平均unique率 | 特記事項 |
|---------|-------------|----------|
| 1.0 | 64% (3.2/5) | 過剰生成あり |
| **1.2** | **92% (4.6/5)** | 🏛️🔥出現 |
| 1.5 | 100% | 🤔出現あり |

### 発見

1. **penalty=1.2で過剰生成がほぼ解消**
2. **gold絵文字の出現率向上**: 🏛️、🔥、🤔など従来出なかった絵文字が出現
3. **v4_top50 + penalty=1.2が推奨設定**: LLM評価優位 + 過剰生成抑制

### 実装

`src/models/t5_trainer.py`の`generate_emoji`関数に`repetition_penalty`パラメータを追加（デフォルト値: 1.2）

```python
def generate_emoji(
    ...
    repetition_penalty: float = 1.2,  # 追加
    ...
)
```

### 推奨設定

| 項目 | 値 |
|------|-----|
| モデル | v4_top50 |
| repetition_penalty | 1.2 |
| 理由 | LLM評価優位 + 過剰生成抑制 + gold絵文字出現率向上 |

---

## 関連ドキュメント

- [experiment_v4_results.md](experiment_v4_results.md): v4データセット学習実験の結果
- [evaluation.md](../evaluation.md): 評価方法の詳細
- [status.md](../status.md): プロジェクト進捗
